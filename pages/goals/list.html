<!-- =====================
File: pages/goals/list.html
===================== -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>目標列表 - 更好的自己</title>
  <link rel="stylesheet" href="../../src/styles/main.css" />
  <style>
    .list-container {
      max-width: 900px;
      margin: 2rem auto;
    }

    .search-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .search-bar input {
      flex: 1;
      min-width: 200px;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 1rem;
    }

    .search-bar button {
      padding: 0.75rem 1.5rem;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .search-bar button:hover {
      background-color: var(--hover-color);
      transform: translateY(-2px);
    }

    .goals-grid {
      display: grid;
      gap: 1.5rem;
    }

    .goal-card {
      background-color: var(--nav-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .goal-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }

    .goal-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-color);
      flex: 1;
    }

    .goal-badge {
      display: inline-block;
      padding: 0.35rem 0.85rem;
      background-color: var(--accent-color);
      color: white;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
      margin-left: 1rem;
    }

    .goal-meta {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #94a3b8;
      flex-wrap: wrap;
    }

    .goal-description {
      color: #cbd5e1;
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .progress-bar {
      height: 8px;
      background-color: var(--border-color);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), #7577f5);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 1.5rem;
    }

    .progress-percentage {
      font-weight: 700;
      color: var(--accent-color);
    }

    .goal-actions {
      display: flex;
      gap: 0.75rem;
    }

    .goal-actions button {
      flex: 1;
      padding: 0.65rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .btn-track {
      background: linear-gradient(135deg, var(--accent-color), #7577f5);
      color: white;
    }

    .btn-track:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn-delete {
      background-color: transparent;
      border: 1px solid #ef4444;
      color: #ef4444;
    }

    .btn-delete:hover {
      background-color: #ef4444;
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #94a3b8;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: #cbd5e1;
    }

    .empty-state p {
      margin-bottom: 2rem;
      font-size: 1rem;
    }

    .empty-state a {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background-color: var(--accent-color);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .empty-state a:hover {
      background-color: var(--hover-color);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1>📋 目標列表</h1>
      <p class="subtitle">查看並管理你的所有目標</p>
    </div>

    <nav>
      <a href="../../index.html">首頁</a>
      <a href="list.html" class="active">目標列表</a>
      <a href="create.html">新增目標</a>
      <a href="../progress/track.html">進度追蹤</a>
    </nav>

    <main class="list-container">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="搜尋目標名稱或類別...">
        <button id="newGoalBtn">➕ 新增目標</button>
      </div>

      <div id="goalsList" class="goals-grid"></div>
      <div id="emptyState" class="empty-state" style="display: none;">
        <h3>😊 還沒有目標呢</h3>
        <p>開始設定你的第一個目標，開啟蛻變之旅吧！</p>
        <a href="create.html">建立第一個目標</a>
      </div>
    </main>
  </div>

  <script src="../../src/js/core.js"></script>
  <script>
    (function() {
      const goalsList = document.getElementById('goalsList');
      const emptyState = document.getElementById('emptyState');
      const searchInput = document.getElementById('searchInput');
      const newGoalBtn = document.getElementById('newGoalBtn');

      newGoalBtn.addEventListener('click', () => {
        window.location.href = 'create.html';
      });

      function renderGoals(goals) {
        goalsList.innerHTML = '';

        if (goals.length === 0) {
          emptyState.style.display = 'block';
          return;
        }

        emptyState.style.display = 'none';

        goals.forEach(goal => {
          const progress = window.goalManager.getGoalProgress(goal);
          const daysRemaining = window.goalManager.getDaysRemaining(goal);

          const card = document.createElement('div');
          card.className = 'goal-card';
          card.innerHTML = `
            <div class="goal-header">
              <h2 class="goal-title">${escapeHtml(goal.title)}</h2>
              <span class="goal-badge">${getCategoryEmoji(goal.category)} ${goal.category}</span>
            </div>

            <div class="goal-meta">
              <span>📅 ${goal.targetDate}</span>
              <span>⏳ 剩餘 ${daysRemaining} 天</span>
              <span>📊 ${progress.done}/${progress.total} 完成</span>
            </div>

            <p class="goal-description">${escapeHtml(goal.description)}</p>

            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress.percentage}%"></div>
            </div>

            <div class="progress-info">
              <span>進度</span>
              <span class="progress-percentage">${progress.percentage}%</span>
            </div>

            <div class="goal-actions">
              <button class="btn-track" data-action="track" data-id="${goal.id}">▶️ 追蹤進度</button>
              <button class="btn-delete" data-action="delete" data-id="${goal.id}">🗑️ 刪除</button>
            </div>
          `;

          goalsList.appendChild(card);
        });

        // 添加事件監聽
        goalsList.addEventListener('click', (e) => {
          const button = e.target.closest('button');
          if (!button) return;

          const action = button.getAttribute('data-action');
          const id = button.getAttribute('data-id');

          if (action === 'track') {
            window.location.href = `../progress/track.html?id=${id}`;
          } else if (action === 'delete') {
            if (confirm('確定要刪除這個目標嗎？')) {
              window.goalManager.deleteGoal(id);
              load();
            }
          }
        });
      }

      function load() {
        const allGoals = window.goalManager.getAllGoals();
        const searchTerm = searchInput.value.toLowerCase();

        const filtered = allGoals.filter(goal => {
          const hay = [goal.title, goal.category, goal.description].join(' ').toLowerCase();
          return hay.includes(searchTerm);
        });

        renderGoals(filtered);
      }

      function getCategoryEmoji(category) {
        const emojis = {
          health: '💪',
          learning: '📚',
          career: '🎯',
          relationship: '💝',
          finance: '💰',
          hobby: '🎨',
          other: '✨'
        };
        return emojis[category] || '✨';
      }

      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
      }

      searchInput.addEventListener('input', load);
      load();
    })();
  </script>
</body>
</html>

<!-- =====================
File: pages/progress/track.html
===================== -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>進度追蹤 - Better Me</title>
  <link rel="stylesheet" href="../../src/styles/main.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    .list{display:grid;gap:8px}
    .task{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;border:1px solid var(--border,#334155);background:#0b1020;border-radius:12px;padding:10px}
    .task.done{opacity:.6}
    .muted{color:#94a3b8}
    .badge{font-size:12px;border:1px solid var(--border,#334155);border-radius:999px;padding:2px 8px;display:inline-block;color:#94a3b8}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .btn{border:1px solid var(--border,#334155);background:#0b1020;color:#e5e7eb;padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#38bdf8,#22c55e);border:0}
    .progress{height:10px;background:#0b1020;border:1px solid var(--border,#334155);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#38bdf8,#22c55e)}
    .toolbar{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
    select,input[type="date"]{padding:8px 10px;border-radius:10px;border:1px solid var(--border,#334155);background:#0b1020;color:#e5e7eb}
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1 id="title">進度追蹤</h1>
      <p class="subtitle" id="subtitle"></p>
    </div>

    <nav>
      <a href="../../index.html">首頁</a>
      <a href="../goals/list.html">目標列表</a>
      <a href="../goals/create.html">新增目標</a>
      <a href="track.html" class="active">進度追蹤</a>
    </nav>

    <main>
      <div class="toolbar">
        <div class="progress" style="flex:1;min-width:220px"><div id="bar" class="bar"></div></div>
        <span class="muted">完成度：<span id="pct">0%</span>｜已完成 <span id="doneCnt">0</span> / <span id="totalCnt">0</span> 項｜連續天數 <span id="streak">0</span></span>
        <button class="btn" id="markToday">勾選今天以前</button>
        <button class="btn" id="exportGoal">匯出此目標</button>
      </div>

      <div class="toolbar">
        <label class="muted">區間：</label>
        <input type="date" id="from" />
        <span>→</span>
        <input type="date" id="to" />
        <select id="quickRange">
          <option value="all">全部</option>
          <option value="7">最近 7 天</option>
          <option value="14">最近 14 天</option>
          <option value="30">最近 30 天</option>
        </select>
      </div>

      <div id="list" class="list"></div>
      <p id="empty" class="muted" style="display:none">此目標目前沒有排程或落在所選區間以外。</p>
    </main>
  </div>

  <script src="../../src/js/track.js"></script>
</body>
</html>

<!-- =====================
File: src/js/list.js
===================== -->
<script>
(function(){
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const q = document.getElementById('q');
  const exportAllBtn = document.getElementById('exportAll');
  const clearAllBtn = document.getElementById('clearAll');

  function readGoals(){
    try{ return JSON.parse(localStorage.getItem('betterme:goals')||'[]'); }catch{ return []; }
  }
  function writeGoals(v){ localStorage.setItem('betterme:goals', JSON.stringify(v)); }

  function progressOf(g){
    const sched = g.schedule||[];
    if(!sched.length) return {pct:0,done:0,total:0};
    const done = sched.filter(t=>t.done).length;
    const total = sched.length;
    return {pct: Math.round(done*100/total), done, total};
  }

  function render(list){
    grid.innerHTML='';
    if(!list.length){ empty.style.display=''; return; }
    empty.style.display='none';
    list.forEach(g=>{
      const p = progressOf(g);
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <div class="row">
          <h3>${g.title}</h3>
          <span class="badge">${g.type==='habit'?'習慣':'專案'}｜${g.category}</span>
        </div>
        <p class="muted">${g.description||''}</p>
        <div class="muted">${g.startDate} → ${g.targetDate}</div>
        <div class="progress"><div class="bar" style="width:${p.pct}%"></div></div>
        <div class="row">
          <span class="muted">完成 ${p.done}/${p.total}（${p.pct}%）</span>
          <div>
            <button class="btn" data-act="open" data-id="${g.id}">查看</button>
            <button class="btn primary" data-act="track" data-id="${g.id}">追蹤</button>
            <button class="btn" data-act="del" data-id="${g.id}">刪除</button>
          </div>
        </div>`;
      grid.appendChild(card);
    });
  }

  function load(){ render(readGoals()); }

  grid.addEventListener('click', (e)=>{
    const act = e.target.getAttribute('data-act');
    const id = e.target.getAttribute('data-id');
    if(!act||!id) return;
    const list = readGoals();
    if(act==='open'){
      window.location.href = `../progress/track.html?id=${id}`;
    }
    if(act==='track'){
      window.location.href = `../progress/track.html?id=${id}`;
    }
    if(act==='del'){
      if(confirm('確定刪除此目標？')){
        writeGoals(list.filter(g=>g.id!==id));
        load();
      }
    }
  });

  q.addEventListener('input', ()=>{
    const kw = q.value.trim().toLowerCase();
    const list = readGoals().filter(g=>{
      const hay = [g.title,g.category,(g.tags||[]).join(',')].join(' ').toLowerCase();
      return !kw || hay.includes(kw);
    });
    render(list);
  });

  exportAllBtn.addEventListener('click', ()=>{
    const blob = new Blob([localStorage.getItem('betterme:goals')||'[]'], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='betterme-goals.json'; a.click(); URL.revokeObjectURL(url);
  });

  clearAllBtn.addEventListener('click', ()=>{
    if(confirm('確定清除所有目標？此動作無法復原。')){ writeGoals([]); load(); }
  });

  load();
})();
</script>

<!-- =====================
File: src/js/track.js
===================== -->
<script>
(function(){
  const title = document.getElementById('title');
  const subtitle = document.getElementById('subtitle');
  const listEl = document.getElementById('list');
  const empty = document.getElementById('empty');
  const bar = document.getElementById('bar');
  const pctEl = document.getElementById('pct');
  const doneCnt = document.getElementById('doneCnt');
  const totalCnt = document.getElementById('totalCnt');
  const streakEl = document.getElementById('streak');
  const markTodayBtn = document.getElementById('markToday');
  const exportGoalBtn = document.getElementById('exportGoal');

  const from = document.getElementById('from');
  const to = document.getElementById('to');
  const quickRange = document.getElementById('quickRange');

  function qs(name){ return new URLSearchParams(location.search).get(name); }
  function readGoals(){ try{ return JSON.parse(localStorage.getItem('betterme:goals')||'[]'); }catch{ return []; } }
  function writeGoals(v){ localStorage.setItem('betterme:goals', JSON.stringify(v)); }

  const id = qs('id');
  const store = readGoals();
  let goal = store.find(g=>g.id===id);
  if(!goal){
    // fallback: 若沒帶 id，顯示第一個
    goal = store[0];
  }
  if(!goal){
    title.textContent = '進度追蹤';
    subtitle.textContent = '尚無目標，請先建立。';
    empty.style.display='';
    return;
  }

  document.title = `進度追蹤 - ${goal.title}`;
  title.textContent = goal.title;
  subtitle.textContent = `${goal.startDate} → ${goal.targetDate}｜${goal.type==='habit'?'習慣':'專案'}｜${goal.category}`;

  // 日期區間預設
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function addDays(dateStr, delta){ const d=new Date(dateStr); d.setDate(d.getDate()+delta); return d.toISOString().slice(0,10); }

  from.value = goal.startDate;
  to.value = goal.targetDate;
  quickRange.addEventListener('change', ()=>{
    const v = quickRange.value;
    if(v==='all'){ from.value = goal.startDate; to.value = goal.targetDate; render(); return; }
    to.value = todayISO();
    from.value = addDays(to.value, -Number(v)+1);
    render();
  });

  [from,to].forEach(el=>el.addEventListener('change', render));

  function progressOf(tasks){
    const total = tasks.length;
    const done = tasks.filter(t=>t.done).length;
    const pct = total? Math.round(done*100/total):0;
    return {total,done,pct};
  }

  function calcStreak(tasks){
    // 以排程順序（日期排序）從頭開始計算連續完成（休息日視為不中斷）
    let s=0;
    for(const t of tasks){
      if(t.rest){ s++; continue; }
      if(t.done){ s++; } else break;
    }
    return s;
  }

  function render(){
    const all = (goal.schedule||[]).slice().sort((a,b)=>a.date.localeCompare(b.date));
    const range = all.filter(t=>(!from.value||t.date>=from.value)&&(!to.value||t.date<=to.value));

    listEl.innerHTML='';
    if(!range.length){ empty.style.display=''; updateProgress(range); return; }
    empty.style.display='none';

    range.forEach((t,idx)=>{
      const row = document.createElement('div');
      row.className = 'task'+(t.done?' done':'');
      const idc = `cb-${idx}`;
      row.innerHTML = `
        <input type="checkbox" id="${idc}" ${t.done?'checked':''} ${t.rest?'disabled':''} />
        <div>
          <div><strong>${t.date}</strong> — ${t.text}</div>
          ${(t.amount?`<div class="muted">建議量：${t.amount}${t.unit||''}</div>`:'')}
        </div>
        <span class="badge">${t.rest?'REST':'TASK'}</span>
      `;
      listEl.appendChild(row);
      const cb = row.querySelector('input');
      cb.addEventListener('change', ()=>{
        t.done = cb.checked;
        row.classList.toggle('done', t.done);
        // 回寫
        const list = readGoals();
        const idxG = list.findIndex(g=>g.id===goal.id);
        if(idxG>=0){ list[idxG] = goal; writeGoals(list); }
        updateProgress(range);
      });
    });

    updateProgress(range);
  }

  function updateProgress(tasks){
    const p = progressOf(tasks);
    bar.style.width = p.pct+'%';
    pctEl.textContent = p.pct+'%';
    doneCnt.textContent = p.done; totalCnt.textContent = p.total;
    // 連續天數以全部排程計算
    streakEl.textContent = calcStreak((goal.schedule||[]).slice().sort((a,b)=>a.date.localeCompare(b.date)));
  }

  markTodayBtn.addEventListener('click', ()=>{
    const today = todayISO();
    (goal.schedule||[]).forEach(t=>{ if(!t.rest && t.date<=today){ t.done=true; } });
    // 回寫
    const list = readGoals();
    const idxG = list.findIndex(g=>g.id===goal.id);
    if(idxG>=0){ list[idxG]=goal; writeGoals(list); }
    render();
  });

  exportGoalBtn.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(goal,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`goal-${goal.id}.json`; a.click(); URL.revokeObjectURL(url);
  });

  render();
})();
</script>