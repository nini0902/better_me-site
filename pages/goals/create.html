<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>新增目標 - 更好的自己</title>
  <link rel="stylesheet" href="../../src/styles/main.css"/>
  <style>
    .simple-form {
      max-width: 600px;
      margin: 2rem auto;
      background-color: var(--nav-bg);
      padding: 2rem;
      border-radius: 16px;
      border: 1px solid var(--border-color);
    }

    .form-field {
      margin-bottom: 1.5rem;
    }

    .form-field label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--accent-color);
      font-size: 0.95rem;
    }

    .form-field input,
    .form-field textarea,
    .form-field select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .form-field input:focus,
    .form-field textarea:focus,
    .form-field select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }

    .form-field textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-hint {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-top: 0.3rem;
      font-style: italic;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .btn {
      flex: 1;
      padding: 0.85rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-color), #7577f5);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn-secondary {
      background-color: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-color);
    }

    .btn-secondary:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .success-message {
      display: none;
      background-color: #10b981;
      color: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
    }

    .error-message {
      display: none;
      background-color: #ef4444;
      color: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1>✨ 設定新目標</h1>
      <p class="subtitle">開始你的蛻變之旅</p>
    </div>

    <nav>
      <a href="../../index.html">首頁</a>
      <a href="list.html">目標列表</a>
      <a href="create.html" class="active">新增目標</a>
      <a href="../progress/track.html">進度追蹤</a>
    </nav>

    <main>
      <form id="goalForm" class="simple-form">
        <div id="successMsg" class="success-message"></div>
        <div id="errorMsg" class="error-message"></div>

        <!-- 目標名稱 -->
        <div class="form-field">
          <label for="goalTitle">📌 目標名稱 *</label>
          <input 
            type="text" 
            id="goalTitle" 
            name="goalTitle" 
            placeholder="例如：每天喝水 2000ml"
            required
          >
          <div class="form-hint">簡潔明確的目標名稱</div>
        </div>

        <!-- 類別 -->
        <div class="form-field">
          <label for="goalCategory">🏷️ 類別 *</label>
          <select id="goalCategory" name="goalCategory" required>
            <option value="">-- 選擇類別 --</option>
            <option value="health">💪 健康運動</option>
            <option value="learning">📚 學習成長</option>
            <option value="career">🎯 工作職涯</option>
            <option value="relationship">💝 人際關係</option>
            <option value="finance">💰 理財投資</option>
            <option value="hobby">🎨 興趣愛好</option>
            <option value="other">✨ 其他</option>
          </select>
        </div>

        <!-- 描述 -->
        <div class="form-field">
          <label for="goalDescription">📝 為什麼要做這個目標？ *</label>
          <textarea 
            id="goalDescription" 
            name="goalDescription"
            placeholder="寫下你想達成這個目標的原因和方法..."
            required
          ></textarea>
          <div class="form-hint">幫助你保持動力的關鍵</div>
        </div>

        <!-- 目標時間和數值 -->
        <div class="form-row">
          <div class="form-field">
            <label for="targetDate">🗓️ 目標完成日期 *</label>
            <input type="date" id="targetDate" name="targetDate" required>
            <div class="form-hint" id="daysHint"></div>
          </div>

          <div class="form-field">
            <label for="quantValue">📊 目標數值（可選）</label>
            <input 
              type="number" 
              id="quantValue" 
              name="quantValue" 
              placeholder="例如：2000"
              min="0"
            >
          </div>
        </div>

        <!-- 單位 -->
        <div class="form-field">
          <label for="quantUnit">📏 單位（可選）</label>
          <input 
            type="text" 
            id="quantUnit" 
            name="quantUnit" 
            placeholder="例如：ml、分鐘、次、頁"
          >
          <div class="form-hint">搭配數值使用，例如「2000 ml」、「20 分鐘」</div>
        </div>

        <!-- 按鈕 -->
        <div class="button-group">
          <button type="submit" class="btn btn-primary">✅ 建立目標</button>
          <button type="reset" class="btn btn-secondary">🔄 重設</button>
        </div>
      </form>
    </main>
  </div>

  <script src="../../src/js/core.js"></script>
  <script>
    (function() {
      const form = document.getElementById('goalForm');
      const titleInput = document.getElementById('goalTitle');
      const categorySelect = document.getElementById('goalCategory');
      const descriptionTextarea = document.getElementById('goalDescription');
      const targetDateInput = document.getElementById('targetDate');
      const quantValueInput = document.getElementById('quantValue');
      const quantUnitInput = document.getElementById('quantUnit');
      const successMsg = document.getElementById('successMsg');
      const errorMsg = document.getElementById('errorMsg');
      const daysHint = document.getElementById('daysHint');

      // 計算剩餘天數
      targetDateInput.addEventListener('change', () => {
        const target = new Date(targetDateInput.value);
        const today = new Date();
        const days = Math.ceil((target - today) / (1000 * 60 * 60 * 24));

        if (days < 0) {
          daysHint.textContent = '⚠️ 日期不能是過去';
          daysHint.style.color = '#ef4444';
        } else if (days === 0) {
          daysHint.textContent = '⏰ 今天截止';
          daysHint.style.color = '#f59e0b';
        } else {
          daysHint.textContent = `⏳ 剩餘 ${days} 天`;
          daysHint.style.color = '#10b981';
        }
      });

      // 提交表單
      form.addEventListener('submit', (e) => {
        e.preventDefault();

        // 基本驗證
        if (!titleInput.value.trim()) {
          showError('請輸入目標名稱');
          return;
        }

        if (!categorySelect.value) {
          showError('請選擇目標類別');
          return;
        }

        if (!descriptionTextarea.value.trim()) {
          showError('請描述你的目標');
          return;
        }

        if (!targetDateInput.value) {
          showError('請選擇目標完成日期');
          return;
        }

        const targetDate = new Date(targetDateInput.value);
        if (targetDate < new Date()) {
          showError('目標日期不能是過去');
          return;
        }

        try {
          // 新增目標
          const goalData = {
            title: titleInput.value.trim(),
            category: categorySelect.value,
            description: descriptionTextarea.value.trim(),
            targetDate: targetDateInput.value,
            quantValue: quantValueInput.value ? parseInt(quantValueInput.value) : 0,
            quantUnit: quantUnitInput.value.trim()
          };

          const newGoal = window.goalManager.addGoal(goalData);
          
          // 生成排程
          const schedule = window.goalManager.generateHabitSchedule(newGoal);
          window.goalManager.updateGoal(newGoal.id, { schedule });

          // 成功提示
          showSuccess('✅ 目標建立成功！');

          // 1.5秒後跳轉到進度追蹤頁面
          setTimeout(() => {
            window.location.href = `../progress/track.html?id=${newGoal.id}`;
          }, 1500);

        } catch (err) {
          console.error(err);
          showError('發生錯誤，請重試');
        }
      });

      function showSuccess(msg) {
        successMsg.textContent = msg;
        successMsg.style.display = 'block';
        errorMsg.style.display = 'none';
      }

      function showError(msg) {
        errorMsg.textContent = msg;
        errorMsg.style.display = 'block';
        successMsg.style.display = 'none';
      }

      // 初始化日期
      targetDateInput.valueAsDate = new Date();
      targetDateInput.dispatchEvent(new Event('change'));
    })();
  </script>
</body>
</html>
