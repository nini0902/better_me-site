<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>進度追蹤 - 更好的自己</title>
    <link rel="stylesheet" href="../../src/styles/main.css">
    <style>
      .track-container {
        max-width: 800px;
        margin: 2rem auto;
      }

      .goal-summary {
        background-color: var(--nav-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .summary-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .summary-meta {
        display: flex;
        gap: 2rem;
        margin: 1.5rem 0;
        flex-wrap: wrap;
        font-size: 0.95rem;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .meta-label {
        color: #94a3b8;
      }

      .meta-value {
        font-weight: 700;
        color: var(--accent-color);
      }

      .progress-section {
        background-color: var(--nav-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .section-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
      }

      .progress-large {
        height: 12px;
        background-color: var(--border-color);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 1rem;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-color), #7577f5);
        transition: width 0.3s ease;
      }

      .progress-text {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: #94a3b8;
      }

      .progress-percentage {
        font-weight: 700;
        color: var(--accent-color);
      }

      .tasks-list {
        display: grid;
        gap: 0.75rem;
        max-height: 400px;
        overflow-y: auto;
      }

      .task-item {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 1rem;
        align-items: center;
        padding: 1rem;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .task-item.done {
        opacity: 0.6;
      }

      .task-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .task-content {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .task-date {
        font-weight: 600;
        color: var(--text-color);
      }

      .task-text {
        font-size: 0.9rem;
        color: #cbd5e1;
      }

      .task-amount {
        font-size: 0.8rem;
        color: #94a3b8;
      }

      .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        flex-wrap: wrap;
      }

      .btn {
        flex: 1;
        min-width: 150px;
        padding: 0.85rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent-color), #7577f5);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
      }

      .btn-secondary {
        background-color: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
      }

      .btn-secondary:hover {
        border-color: var(--accent-color);
        color: var(--accent-color);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #94a3b8;
      }

      .empty-state h3 {
        font-size: 1.3rem;
        margin-bottom: 1rem;
        color: #cbd5e1;
      }

      .empty-state p {
        margin-bottom: 1.5rem;
      }

      .filter-bar {
        background-color: var(--nav-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .filter-bar label {
        color: #94a3b8;
        font-size: 0.9rem;
      }

      .filter-bar input,
      .filter-bar select {
        padding: 0.6rem 0.85rem;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-color);
        font-size: 0.9rem;
      }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>📊 進度追蹤</h1>
            <p class="subtitle">看見每一步的進步</p>
        </div>
        <nav>
            <a href="../../index.html">首頁</a>
            <a href="../goals/list.html">目標列表</a>
            <a href="../goals/create.html">新增目標</a>
            <a href="track.html" class="active">進度追蹤</a>
        </nav>
        <main class="track-container" id="mainContent"></main>
    </div>

    <script src="../../src/js/core.js"></script>
    <script>
      (function() {
        const mainContent = document.getElementById('mainContent');

        function getQueryParam(name) {
          const params = new URLSearchParams(window.location.search);
          return params.get(name);
        }

        function escapeHtml(text) {
          const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
          };
          return text.replace(/[&<>"']/g, m => map[m]);
        }

        function getCategoryEmoji(category) {
          const emojis = {
            health: '💪',
            learning: '📚',
            career: '🎯',
            relationship: '💝',
            finance: '💰',
            hobby: '🎨',
            other: '✨'
          };
          return emojis[category] || '✨';
        }

        function render() {
          const goalId = getQueryParam('id');
          let goal = null;

          if (goalId) {
            goal = window.goalManager.getGoal(goalId);
          } else {
            // 沒有指定 ID，取第一個目標
            const allGoals = window.goalManager.getAllGoals();
            goal = allGoals[0];
          }

          if (!goal) {
            mainContent.innerHTML = `
              <div class="empty-state">
                <h3>😊 尚無目標</h3>
                <p>請先建立一個目標來開始追蹤進度</p>
                <a href="../goals/create.html" class="btn btn-primary" style="display: inline-block; margin-top: 1rem;">
                  建立第一個目標
                </a>
              </div>
            `;
            return;
          }

          const progress = window.goalManager.getGoalProgress(goal);
          const schedule = goal.schedule || [];
          const today = new Date().toISOString().slice(0, 10);

          let html = `
            <!-- 目標摘要 -->
            <div class="goal-summary">
              <h2 class="summary-title">
                ${getCategoryEmoji(goal.category)} ${escapeHtml(goal.title)}
              </h2>
              <p style="color: #cbd5e1; margin-bottom: 1rem;">${escapeHtml(goal.description)}</p>
              <div class="summary-meta">
                <div class="meta-item">
                  <span class="meta-label">📅 期限：</span>
                  <span class="meta-value">${goal.targetDate}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">⏳ 剩餘：</span>
                  <span class="meta-value">${window.goalManager.getDaysRemaining(goal)} 天</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">💯 進度：</span>
                  <span class="meta-value">${progress.percentage}%</span>
                </div>
              </div>
            </div>

            <!-- 進度條 -->
            <div class="progress-section">
              <div class="section-title">📈 整體進度</div>
              <div class="progress-large">
                <div class="progress-fill" style="width: ${progress.percentage}%"></div>
              </div>
              <div class="progress-text">
                <span>已完成 ${progress.done} / 總共 ${progress.total} 項</span>
                <span class="progress-percentage">${progress.percentage}%</span>
              </div>
            </div>

            <!-- 任務列表 -->
            <div class="progress-section">
              <div class="section-title">✅ 今日及後續任務</div>
              <div class="tasks-list" id="tasksList"></div>
            </div>

            <!-- 行動按鈕 -->
            <div class="action-buttons">
              <button class="btn btn-primary" id="markTodayBtn">✓ 勾選至今日</button>
              <button class="btn btn-secondary" id="backBtn">← 返回列表</button>
            </div>
          `;

          mainContent.innerHTML = html;

          // 渲染任務列表
          const tasksList = document.getElementById('tasksList');
          if (schedule.length === 0) {
            tasksList.innerHTML = '<p style="color: #94a3b8; text-align: center;">尚無任務安排</p>';
          } else {
            schedule.forEach((task, idx) => {
              const isToday = task.date === today;
              const isPast = task.date < today;
              const taskItem = document.createElement('div');
              taskItem.className = `task-item ${task.done ? 'done' : ''}`;
              taskItem.innerHTML = `
                <input type="checkbox" ${task.done ? 'checked' : ''} class="task-checkbox" data-index="${idx}">
                <div class="task-content">
                  <div class="task-date">${task.date} ${isToday ? '📍 今日' : isPast ? '⏰ 已過期' : ''}</div>
                  <div class="task-text">${escapeHtml(task.text)}</div>
                  ${task.amount ? `<div class="task-amount">目標：${task.amount}${escapeHtml(task.unit || '')}</div>` : ''}
                </div>
                <span style="color: #94a3b8; font-size: 0.85rem; white-space: nowrap;">
                  ${task.done ? '✅' : '○'}
                </span>
              `;

              const checkbox = taskItem.querySelector('.task-checkbox');
              checkbox.addEventListener('change', (e) => {
                const tasks = goal.schedule;
                tasks[idx].done = e.target.checked;
                window.goalManager.updateGoal(goal.id, { schedule: tasks });
                render();
              });

              tasksList.appendChild(taskItem);
            });
          }

          // 事件監聽
          document.getElementById('markTodayBtn').addEventListener('click', () => {
            schedule.forEach(task => {
              if (!task.done && task.date <= today) {
                task.done = true;
              }
            });
            window.goalManager.updateGoal(goal.id, { schedule });
            render();
          });

          document.getElementById('backBtn').addEventListener('click', () => {
            window.location.href = '../goals/list.html';
          });
        }

        render();
      })();
    </script>
</body>
</html>